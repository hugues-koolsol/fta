<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="utf-8" />
 <title>html home</title>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <link rel="stylesheet" href="index.css" />
</head>
<body>
  <nav>
    <a href="index.html">html home</a>
    <a href="index.php">php home</a>
    <a href="todo.html">todo</a>
    <a href="funcToArray6.html">funcToArray6</a>
    <a href="aa_login.php">login</a>
  </nav>
  <h1>HTML HOME  &#128169;</h1>
  <ul class="menu2">
    <li><a href="index.html">html home</a></li>
    <li><a href="index.php">php home</a></li>
    <li><a href="index_php.html">index_php.html</a></li>
    <li><a href="index_js.html">index_js.html</a></li>
    <li><a href="indexfu.html">indexfu.html</a></li>
    <li><a href="index_source.html">index_source.html</a></li>
  </ul>
  <textarea class="txtar1" id="txtar1" rows="4">     // debut
a(
   // test üëç
 b(xx()
     //aa
), 
 // comment 1
 c(
  ' dd  ',   
 // bla
   // blu
  ee,
  2
  // @
 ) 
// comment 2
), 
   // I√±t√´rn√¢ti√¥n√†√†ÃÄliz√¶ti√∏n ‚òÉ üí© ‚ù§ üòÅ üëç
f(g),
//üëç</textarea>
  <a href="javascript:transform()">transform</a>
  <div id="message1"></div>
  <div id="resultat1"></div>
  <script type="text/javascript" src="js/core2.js"></script>
<script type="text/javascript">


function iterateCharacters(str) {
// https://stackoverflow.com/questions/63905684/how-can-a-3-byte-wide-utf-8-character-only-use-a-single-utf-16-code-unit
  var out=[];
  let te = new TextEncoder();
  let position=0;
  let position2=0;
  let arr = [...str];
  for (let i = 0; i < arr.length; i++) {
    let bytes = te.encode(arr[i]).length;
    let length = arr[i].length;
    out.push([arr[i],bytes,position,position2]);
    position+=bytes;
    position2+=(bytes==4?2:1);
  }
  return {'out':out,'position':position,'position2':position2};  
}


function microtime(getAsFloat) {
    var s, now, multiplier;

    if(typeof performance !== 'undefined' && performance.now) {
        now = (performance.now() + performance.timing.navigationStart) / 1000;
        multiplier = 1e6; // 1,000,000 for microseconds
    }
    else {
        now = (Date.now ? Date.now() : new Date().getTime()) / 1000;
        multiplier = 1e3; // 1,000
    }

    // Getting microtime as a float is easy
    if(getAsFloat) {
        return now;
    }

    // Dirty trick to only get the integer part
    s = now | 0;

    return (Math.round((now - s) * multiplier ) / multiplier ) + ' ' + s;
}

function transform(){
  //"√†aÃÄ"


  document.getElementById('message1').innerHTML='';
  document.getElementById('resultat1').innerHTML='';

  var a=document.getElementById('txtar1');
  
  var lines = a.value.split(/\r|\r\n|\n/);
  var count = lines.length;
  a.setAttribute('rows',count+1);
  
  
  
  var startMicro=microtime(true);
  var out1=iterateCharacters(a.value);
  var endMicro=microtime(true);
  
  console.log('endMicro=',((endMicro-startMicro)*1000)+' ms');
 
  console.log('out1.out=',out1.out);
  
  var startMicro=microtime(true);
  var b=functionToArray2(out1.out);
  var endMicro=microtime(true);
  console.log('endMicro=',((endMicro-startMicro)*1000)+' ms');


  console.log(b);
  
  document.getElementById('message1').innerHTML='';
  document.getElementById('resultat1').innerHTML='';


  if(b.status===true){
  
    var parent=document.getElementById('resultat1');
    

    var a2fnc2=arrayToFunctNoComment2(b.value,true)
    var dia2fnc2=document.createElement('pre');
    if(a2fnc2.status===true){
     dia2fnc2.innerHTML='<hr  />arrayToFunctNoComment2:\n'+a2fnc2.value;
    }else{
     dia2fnc2.innerHTML='<hr />arrayToFunctNoComment2:'+a2fnc2.message;
    }
    document.getElementById('resultat1').appendChild(dia2fnc2);
    


    
    
    var a2fn=arrayToFunctNormalize(b.value,false)
    var di3=document.createElement('pre');
    if(a2fn.status===true){
     
     di3.innerHTML='<hr />'+a2fn.value+''+(a2fn.value==a.value?'<br /><b style="color:green;">identiques :-)</b>':'<br /><b style="color:red;">diff√©rents :-(</b')+'';
    }else{
     di3.innerHTML='<hr />'+a2fn.message;
    }
    document.getElementById('resultat1').appendChild(di3);
    
    
    
    
    
    var t1=document.createElement('table');
    t1.setAttribute('class','tableau1');
    
    // entete de tableau de l'arbre
    var tr1=document.createElement('tr');
    for(var i=0;i<global_enteteTableau.length;i++){
      var td1=document.createElement('td');
      td1.innerHTML=global_enteteTableau[i][0];
      td1.setAttribute('title',global_enteteTableau[i][1] + '(' + i + ')');
      tr1.appendChild(td1);
    }
    t1.appendChild(tr1);
    
    // arbre
    for(var i=0;i<b.value.length;i++){
      var tr1=document.createElement('tr');
      for(var j=0;j<b.value[i].length;j++){
        var td1=document.createElement('td');
        if(j==1 || ( j>=7 && j<=9 ) ){ // pour les valeurs et les commentaires
         td1.innerHTML=String(b.value[i][j]).replace(/ /g,'‚ñë').replace(/\n/g,'\\n\n');
         td1.style.whiteSpace='pre-wrap';
         td1.style.verticalAlign='baseline';
        }else if(j==4){ // constante quot√©e
         td1.innerHTML=b.value[i][j]===true?'1':'';;
        }else{
         td1.innerHTML=String(b.value[i][j]).replace(/ /g,'‚ñë');
        }
        td1.setAttribute('title',global_enteteTableau[j][1] + '(' + j + ')');
        tr1.appendChild(td1);
      }
      t1.appendChild(tr1);
    }
    document.getElementById('resultat1').appendChild(t1);
//    parent.appendChild(t1);
    
    // d√©composition 
    var t2=document.createElement('table');
    t2.setAttribute('class','tableau2');
    var tr1=document.createElement('tr');
    var td1=document.createElement('td');
    var numeroLigne=0;
    td1.innerHTML=numeroLigne;
    tr1.appendChild(td1);
    var debut=0;
    console.log(a.value);
    
    var outo=iterateCharacters(a.value);
    out=outo.out;
    console.log(out);
    console.log('a.value.length=',a.value.length);
    for(var i=0;i<out.length;i++){
      var td1=document.createElement('td');
      td1.innerHTML=out[i][0].replace('\n','\\n');
      td1.title='&#'+out[i][0].codePointAt(0)+'; ('+out[i][1]+')';
      tr1.appendChild(td1);
      
      
      if(out[i][0]==='\n'){
       t2.appendChild(tr1);
       
       // indice dans tableau = premi√®re ligne des chiffres
       var tr1=document.createElement('tr');
       var td1=document.createElement('td');
       td1.setAttribute('class','td2');
       td1.innerHTML='&nbsp;';
       tr1.appendChild(td1);
       
       for(var j=debut;j<i;j++){
         var td1=document.createElement('td');
         if(out[j][1]==1){
          td1.setAttribute('class','td2');
         }else if(out[j][1]==3  ){
          td1.setAttribute('class','td5');
         }else if( out[j][1]==4 ){
          td1.setAttribute('class','td4');
         }else{
          td1.setAttribute('class','td3');
         }
         td1.innerHTML=j;
         tr1.appendChild(td1);
       }
       // position du backslash n
       var td1=document.createElement('td');
       td1.setAttribute('class','td2');
       td1.innerHTML=j+'';
       tr1.appendChild(td1);
       
       t2.appendChild(tr1);
       


       
       // position dans la chaine = deuxi√®me ligne des chiffres

       var tr1=document.createElement('tr');
       var td1=document.createElement('td');
       td1.setAttribute('class','td2');
       td1.innerHTML='&nbsp;';
       tr1.appendChild(td1);
       
       for(var j=debut;j<i;j++){
         var td1=document.createElement('td');
         if(out[j][1]==1){
          td1.setAttribute('class','td2');
         }else if(out[j][1]==3  ){
          td1.setAttribute('class','td5');
         }else if( out[j][1]==4 ){
          td1.setAttribute('class','td4');
         }else{
          td1.setAttribute('class','td3');
         }
         td1.innerHTML=out[j][3]+'';
         tr1.appendChild(td1);
       }
       // position du backslash n
       var td1=document.createElement('td');
       td1.setAttribute('class','td2');
       td1.innerHTML=out[j][3]+'';
       tr1.appendChild(td1);
       
       t2.appendChild(tr1);
       
       

       // fin des lignes 
       
       
       debut=i+1;

       
       
       var tr1=document.createElement('tr');
       numeroLigne++;
       var td1=document.createElement('td');
       td1.innerHTML=numeroLigne;
       tr1.appendChild(td1);
       t2.appendChild(tr1);
       
      }
      
    }

    t2.appendChild(tr1);


    
    var tr1=document.createElement('tr');
    var td1=document.createElement('td');
    td1.setAttribute('class','td2');
    td1.innerHTML='&nbsp;';
    tr1.appendChild(td1);
    
    for(var j=debut;j<i;j++){
      var td1=document.createElement('td');
      if(out[j][1]==1){
       td1.setAttribute('class','td2');
      }else if(out[j][1]==3  ){
       td1.setAttribute('class','td5');
      }else if( out[j][1]==4 ){
       td1.setAttribute('class','td4');
      }else{
       td1.setAttribute('class','td3');
      }
      td1.innerHTML=j;
      tr1.appendChild(td1);
    }
    
    t2.appendChild(tr1);
    
    

    
    var tr1=document.createElement('tr');
    var td1=document.createElement('td');
    td1.setAttribute('class','td2');
    td1.innerHTML='&nbsp;';
    tr1.appendChild(td1);
    
    for(var j=debut;j<i;j++){
      var td1=document.createElement('td');
      if(out[j][1]==1){
       td1.setAttribute('class','td2');
      }else if(out[j][1]==3  ){
       td1.setAttribute('class','td5');
      }else if( out[j][1]==4 ){
       td1.setAttribute('class','td4');
      }else{
       td1.setAttribute('class','td3');
      }
      td1.innerHTML=out[j][3];
      tr1.appendChild(td1);
    }
    
    t2.appendChild(tr1);
    
    
    
    
/*    
    var td1=document.createElement('td');
    td1.setAttribute('class','td2');
    td1.innerHTML=i;
    tr1.appendChild(td1);
*/    
    
    
    
    document.getElementById('resultat1').appendChild(t2);
    var sp1=document.createElement('span');
    var longueurDernierCaractere=out[out.length-1][1]==4?2:1;
    
    sp1.innerHTML='a.value.length='+a.value.length + ' , out.length=' + out.length + ' , dernier caract√®re:' + a.value.substr( a.value.length-longueurDernierCaractere,longueurDernierCaractere) ;
    document.getElementById('resultat1').appendChild(sp1);
    
    
    
    
    
    var a2fnc=arrayToFunctNoComment(b.value)
    var di1=document.createElement('div');
    if(a2fnc.status===true){
     di1.innerHTML='<hr  />'+a2fnc.value;
    }else{
     di1.innerHTML='<hr />'+a2fnc.message;
    }
    document.getElementById('resultat1').appendChild(di1);
    
    
    
    
    var a2fc=arrayToFunctWidthComment(b.value)
    var di2=document.createElement('pre');
    if(a2fc.status===true){
     
     di2.innerHTML='<hr />'+a2fc.value+''+(a2fc.value==a.value?'<br /><b style="color:green;">identiques :-)</b>':'')+'';
    }else{
     di2.innerHTML='<hr />'+a2fc.message;
    }
    document.getElementById('resultat1').appendChild(di2);
    
    
    var a2fn=arrayToFunctNormalize(b.value,false)
    var di3=document.createElement('pre');
    if(a2fn.status===true){
     
     di3.innerHTML='<hr />'+a2fn.value+''+(a2fn.value==a.value?'<br /><b style="color:green;">identiques :-)</b>':'<br /><b style="color:red;">diff√©rents :-(</b')+'';
    }else{
     di3.innerHTML='<hr />'+a2fn.message;
    }
    document.getElementById('resultat1').appendChild(di3);
    
    

    
    
//    child.addEventListener('click' , myFunct, false ); 
  
  }else{
    var sp1=document.createElement('span');
    sp1.style.color='red';
    sp1.innerHTML=b.message;
    document.getElementById('resultat1').appendChild(sp1);
  }

  
 
}
transform();
</script>
  
</body></html>