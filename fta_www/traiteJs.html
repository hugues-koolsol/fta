<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="utf-8" />
 <title>html home</title>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <link rel="stylesheet" href="index.css" />
</head>
<body>
  <nav>
    <a href="index.html">html home</a>
    <a href="index.php">php home</a>
    <a href="todo.html">todo</a>
    <a href="traiteJs.html">traiteJs</a>
    <a href="aa_login.php">login</a>
  </nav>
  <h1>traiteJs</h1>
  <ul class="menu2">
    <li><a href="javascript:chargerSourceDeTest()">source de test</a></li>
  </ul>
  
  <!-- label>Nom du fichier Js<input name="NomDuJs" id="NomDuJs" value="" style="border: 1px lightgrey inset;" /></label -->
  <div id="zone_global_messages"></div>
  <br />
  <textarea class="txtar1" id="txtar1" rows="4"></textarea>
  <a href="javascript:transform()">transform</a>
  
  <div id="resultat1"></div>
  <script type="text/javascript" src="js/core4.js"></script>
<script type="text/javascript">

/*
BUG !!!!!!!
var a=1;
var b=1+(a==0?4:5);
console.log('b='+b); // b=6
var b=1+ a==0?4:5 ; // on retire les parenthèses
console.log('b='+b); // b=5
*/

//=====================================================================================================================
function traiteDelimiteursChaine1(s,delim,tab,ind,niveau){
 var t='';
 var niveau=0;
 for(var i=0;i<s.length;i++){
  var c=s.substr(i,1)
  if(c==delim){
   if(i==0 || i==s.length-1){
    if(i==s.length-1){
     return {'status':true,'value':t};
    }
   }else{
    if(i>1 && s.substr(i-1,1)=='\\'){
     t=t.substr(0,t.length-1); //+(delim=='"'?'"':'\\\'');
     if(delim=='\''){
      t+='\\\''
     }else{
      t+='"'
     }
    }else{
     return {'status':false,'ind':ind,'value':s};
    }
   }
  }else{
   if(delim=='"' && c=='\''){
    t+='\\\'';
   }else{
    t+=c;
   }
  }
 }
 return {'status':false,'ind':ind,'value':s};
}

//=====================================================================================================================
function analyseChaineSimple1(chaine,tab,ind,niveau){
 var t=chaine;
 var chaineQuotee=false;
 var isNum=false;
 var isComplex=false;
// console.log('chaine="'+chaine+'"');
 if(isNumeric(chaine)){
//  console.log(chaine+' EST NUMERIQUE');
  t=chaine.replace(/ /g,'');
  return {'status':true,'value':t,'chaineQuotee':chaineQuotee,'isNum':true,'isComplex':isComplex};
 }
 for(var i=0;i<chaine.length;i++){
  var c=chaine.substr(i,1);
  if(c!=' '){
   chaine=chaine.substr(i);
   break
  }
 }
 for(var i=chaine.length-1;i>=0;i--){
  var c=chaine.substr(i,1);
  if(c!=' '){
   chaine=chaine.substr(0,i+1);
   break
  }
 }
 if(chaine.substr(0,1)=='"' && chaine.substr(chaine.length-1,1)=='"'){
  chaineQuotee=true;
  var obj=traiteDelimiteursChaine1(chaine,'"',tab,ind,niveau);
  if(obj.status==true){
   t=obj.value;
  }
 }else if(chaine.substr(0,1)=='\'' && chaine.substr(chaine.length-1,1)=='\''){
  chaineQuotee=true;
  var obj=traiteDelimiteursChaine1(chaine,'\'');
  if(obj.status==true){
   t=obj.value;
  }
 }else{
  t=chaine;
 }
 if(chaineQuotee){
   return {'status':false,'ind':ind,'value':t,'chaineQuotee':chaineQuotee,'isNum':false,'isComplex':isComplex};
 }
 var tab='. , \' " < > ! = & | ( ) ?'.split(' ');
 for(var i=0 ; i < t.length && isComplex==false ; i++ ){
  var c=t.substr(i,1);
  for(var j=0;j<tab.length;j++){
   if(tab[j]===c){
    isComplex=true;
    break;
   }
  }
 }
 

 if(isComplex==false){
  return {'status':true,'value':t,'chaineQuotee':chaineQuotee,'isNum':false,'isComplex':isComplex};
 }
 
 // si on arrive ici, c'est q'on a probablement une fonction,
 // au pire, pour l'instant : a.b.c(d,'e').f(g[h][i]) * (x>0&&!(!1==false)?4:5)
 // les délimiteur sont . , ' " < <= > >= != == === !== & | && || ( ) ? ! true false + - * /
 
 return {'status':false,'line':tab[ind][5],'value':t,'chaineQuotee':chaineQuotee,'isNum':false,'isComplex':isComplex};
 
 
}
//=====================================================================================================================
function traiteDeclarationVariable1(tab,ind,niveau,dansFor){
 var t='';
 var ligne='';
 if(dansFor!==''){
  ligne=dansFor;
 }else{
  ligne=tab[ind][4];
 }
 var s=ligne.substr(4);
 var obj1=traiteEgalite1(tab,ind,niveau,s);
 if(obj1.status===true){
  t=obj1.value;
  return {'status':true,'value':t,'fermetureNiveau':false,'ajouterNiveauDedans':0,'gauche':obj1.gauche,'droite':obj1.droite};
 }else{
   temp={'status':false,'line':tab[ind][5],'message':'traiteDeclarationVariable1 : problème dans une déclaration d\'une variable'};
   return(logerreur(temp));
 }
}
//=====================================================================================================================
function traiteEgalite1(tab,ind,niveau,s){
 var t='';
 s=s.replace(';','');
 var tt=s.split('=');
 if(tt.length==2){
   var obj1=analyseChaineSimple1(tt[0],tab,ind,niveau);
   var obj2=analyseChaineSimple1(tt[1],tab,ind,niveau);
   if(obj1.status===true){
    if(obj2.status===true){
     t+='\n'+' '.repeat(niveau*NBESPACESREV)+'declare(';
     if(obj1.chaineQuotee || obj1.isNum || obj1.isComplex ){
      temp={'status':false,'line':tab[ind][5],'message':'problème dans une déclaration d\'une variable'};
      return(logerreur(temp));
     }else{
      t+=obj1.value+'';
     }
     t+=' , ';
     if(obj2.chaineQuotee){
      t+='\''+obj2.value+'\'';
     }else if(obj2.isNum){
      t+=obj2.value+'';
     }else{
      temp={'status':false,'line':tab[ind][5],'message':'problème dans une déclaration d\'une variable'};
      return(logerreur(temp));
     }
     t+=')';
    }else{
     temp={'status':false,'line':tab[ind][5],'message':'problème dans une déclaration d\'une variable'};
     return(logerreur(temp));
    }
   }else{
    temp={'status':false,'line':tab[ind][5],'message':'problème dans une déclaration d\'une variable'};
    return(logerreur(temp));
   }
 }else{
   temp={'status':false,'line':tab[ind][5],'message':'problème dans une déclaration d\'une variable'};
   return(logerreur(temp));
 }
 return {'status':true,'value':t,'fermetureNiveau':false,'ajouterNiveauDedans':0,'gauche':obj1,'droite':obj2};
}
//=====================================================================================================================
function decomposeConditionEnTableau1(tab,ind,niveau,ch){
 var tab1=[];
 var t='';
 var variable1='';
 var niveau=0;
 var c1='';
 var dansChaineDouble=false;
 var dansChaineSimple=false;
 var i=0;
 var j=0;
 var l01=ch.length;
 var id=0;
 var parentId=0;
 //           niveau , id  , parentId    nbEnf     1            2   3avant
 tab1.push([ [niveau , id  , parentId ,  0     ] , variable1 , [] , ''      , '' , '' , [[ '' , '' , [ '' , '' , '' ] ]] ]);
 
 // phase 1 : séparation des parenthèses
 for(i=0;i<l01;i++){
  var c1=ch.substr(i,1);
  if(dansChaineDouble){
  
   variable1+=c1;
   if(c1=='"'){
    dansChaineDouble=false;
   }else{
   
    for(j=i+1;j<l01;j++){
     c2=ch.substr(j,1);
     if(c2=='"'){
      if(c1=='\\'){
       variable1+=c2;
      }else{
       variable1+=c2;
       dansChaineDouble=false;
       i=j;
       break;
      }
     }else{
      variable1+=c2;
     }
    }
   }
   
  }else if(dansChaineSimple){
  
   variable1+=c1;
   if(c1=='\''){
    dansChaineSimple=false;
   }else{
   
    for(j=i+1;j<l01;j++){
     c2=ch.substr(j,1);
     if(c2=='\''){
      if(c1=='\\'){
       variable1+=c2;
      }else{
       variable1+=c2;
       dansChaineSimple=false;
       i=j;
       break;
      }
     }else{
      variable1+=c2;
     }
    }
   }
   
  
  
  }else if(c1=='('){
   variable1=variable1.replace(/\n/g,' ')
   variable1=monTrim(variable1);
   
   if(variable1!==''){
    if(variable1.substr(variable1.length-1,1)=='!'){
     variable1=variable1.substr(0,variable1.length-1);
     variable1=monTrim(variable1);
     variable1+='!';
    }
    id++;
    tab1.push([ [niveau,id,parentId,0] , variable1 , [] , '' , '' , '' , [['' , '' , [ '' , '' , '' ] ]] ]);
   }
   niveau++;
   variable1='';
  }else if(c1==')'){
   variable1=variable1.replace(/\n/g,' ')
   variable1=monTrim(variable1);
   if(variable1!==''){
    id++;
    tab1.push([ [niveau,id,parentId,0] , variable1 , [] , '' , '' , '' , [['' , '' , [ '' , '' , '' ] ]] ]);
   }
   variable1='';
   niveau--;
  }else if(c1=='\''){
   dansChaineSimple=true;
   variable1+=c1;
  }else if(c1=='"'){
   dansChaineDouble=true;
   variable1+=c1;
  }else{
   variable1+=c1;
  }
 }
 
 
 variable1=variable1.replace(/\n/g,' ')
 variable1=monTrim(variable1);
 if(variable1!==''){
  id++;
  tab1.push([ [niveau,id,parentId,0] , variable1 , [] , '' , '' , '' , [[ '' , '' , [ '' , '' , '' ] ]] ]);
 }
 for(var i=tab1.length-1;i>=1;i--){
  var niv=tab1[i][0][0];
  for(var j=i-1;j>=1;j--){
   if(niv>tab1[j][0][0]){
    tab1[i][0][2]=tab1[j][0][1];
    break;
   }
  }
 }
 
 for(var i=tab1.length-1;i>0;i--){
  var par=tab1[i][0][2];
  tab1[par][0][3]++
 }
 

 //======================================================================
 // phase 2 : chaque groupe de parenthèse représente une ligne du tableau
 //======================================================================

 
 var niveauprecedent=999;
 var l01=tab1.length;
 // on sépare les && et ||
 
 for(i=1;i<l01;i++){
  c1=tab1[i][1];
  console.log('niveau et c1='+tab1[i][0][0]+'"'+c1+'"');
  //dans chaque ligne , on explose les && et les || 
  if(c1.length>=3){
   if(c1.substr(0,3)=='&&!' || c1.substr(0,3)=='||!'){
    tab1[i][3]=c1.substr(0,3);
    c1=c1.substr(3);
   }else if(c1.substr(0,2)=='&&' || c1.substr(0,2)=='||'){
    tab1[i][3]=c1.substr(0,2);
    c1=c1.substr(2);
   }
  }else if(c1.length>=2){
   if(c1.substr(0,2)=='&&' || c1.substr(0,2)=='||'){
    tab1[i][3]=c1.substr(0,2);
    c1=c1.substr(2);
   }
  }
  if(niveauprecedent<tab1[i][0][0] && c1!='' && tab1[i-1][4]=='' ){
   // si le niveau courant est inférieur au niveau suivant, la ligne doit de terminer par
   // un "&&!" ou un "||!" ou un "&&" ou un "||"
   if(i<l01-1){
    
    if(c1.length>=3){
     if(c1.substr(c1.length-3,3)=='&&!' || c1.substr(c1.length-3,3)=='||!'){
      tab1[i][4]=c1.substr(c1.length-3,3);
      c1=c1.substr(0,c1.length-3)
     }else if(c1.substr(c1.length-2,2)=='&&' || c1.substr(c1.length-2,2)=='||'){
      tab1[i][4]=c1.substr(c1.length-2,2);
      c1=c1.substr(0,c1.length-2)
     }else{
      return {'status':false,'id':ind,'line':tab[ind][5],'message':'un || ou un && devrait précéder une "(" dans une condition'};
     }
    }else if(c1.length>=2){
     if(c1.substr(c1.length-2,2)=='&&' || c1.substr(c1.length-2,2)=='||'){
      tab1[i][4]=c1.substr(c1.length-2,2);
      c1=c1.substr(0,c1.length-2)
     }else{
      return {'status':false,'id':ind,'line':tab[ind][5],'message':'un || ou un && devrait précéder une "(" dans une condition'};
     }
    }
   }
   
  }
  tab1[i][5]=c1;
  // tab1[i][5] contient des elements de type condition1 && condition2 || condition 3
  // dans tab1[i][6] on explose ces conditions sous la forme [['|et|ou','conditionX'],...]
  dansChaineDouble=false;
  dansChaineSimple=false;
  variable1='';
  var textEtOu='';
  var indiceCondition=0;
  
  for(var j=0;j<tab1[i][5].length-1;j++){
   c1=tab1[i][5].substr(j,1);
   textEtOu=tab1[i][5].substr(j,2);
   if(dansChaineDouble){
   
    variable1+=c1;
    if(c1=='"'){
     dansChaineDouble=false;
    }else{
    
     for(j=i+1;j<l01;j++){
      c2=ch.substr(j,1);
      if(c2=='"'){
       if(c1=='\\'){
        variable1+=c2;
       }else{
        variable1+=c2;
        dansChaineDouble=false;
        i=j;
        break;
       }
      }else{
       variable1+=c2;
      }
     }
    }
    
   }else if(dansChaineSimple){
   
    variable1+=c1;
    if(c1=='\''){
     dansChaineSimple=false;
    }else{
    
     for(j=i+1;j<l01;j++){
      c2=ch.substr(j,1);
      if(c2=='\''){
       if(c1=='\\'){
        variable1+=c2;
       }else{
        variable1+=c2;
        dansChaineSimple=false;
        i=j;
        break;
       }
      }else{
       variable1+=c2;
      }
     }
    }
   }else if(textEtOu=='&&' || textEtOu=='||'){
    tab1[i][6][indiceCondition][1]=monTrim(variable1);
    tab1[i][6].push([textEtOu,'',[ '' , '' , '' ]]);
    indiceCondition++;
    variable1='';
    j++;
   }else{
    variable1+=c1;
   }
  }
  variable1+=tab1[i][5].substr(tab1[i][5].length-1,1)
  tab1[i][6][indiceCondition][1]=monTrim(variable1);
  
   
  dansChaineDouble=false;
  dansChaineSimple=false;
  variable1='';
  var textTest1='';
  var textTest2='';
  var textTest3='';
  var indiceTest=0;
  
  for(var j=0;j<tab1[i][6].length;j++){
  
   var l02=tab1[i][6][j][1].length;
   var str1=tab1[i][6][j][1];
   
   for(var k=0;k<l02;k++){
   
    c1=str1.substr(k,1);
    textTest1=str1.substr(k,1);
    textTest2=str1.substr(k,2);
    textTest3=str1.substr(k,3);
    if(dansChaineDouble){
    
     variable1+=c1;
     if(c1=='"'){
      dansChaineDouble=false;
     }else{
     
      for(var l=k+1;l<l02;l++){
       c2=ch.substr(l,1);
       if(c2=='"'){
        if(c1=='\\'){
         variable1+=c2;
        }else{
         variable1+=c2;
         dansChaineDouble=false;
         k=l;
         break;
        }
       }else{
        variable1+=c2;
       }
      }
     }
     
    }else if(dansChaineSimple){
    
     variable1+=c1;
     if(c1=='\''){
      dansChaineSimple=false;
     }else{
     
      for(var l=k+1;l<l02;l++){
       c2=ch.substr(l,1);
       if(c2=='\''){
        if(c1=='\\'){
         variable1+=c2;
        }else{
         variable1+=c2;
         dansChaineSimple=false;
         k=l;
         break;
        }
       }else{
        variable1+=c2;
       }
      }
     }
    }else if(textTest3=='===' || textTest3=='!=='){
     tab1[i][6][j][2][0]=textTest3;
     tab1[i][6][j][2][1]=monTrim(str1.substr(0,k));
     tab1[i][6][j][2][2]=monTrim(str1.substr(k+3));
     break;
    }else if(textTest2=='==' || textTest2=='!='  || textTest2=='<=' || textTest2=='>='){
     tab1[i][6][j][2][0]=textTest2;
     tab1[i][6][j][2][1]=monTrim(str1.substr(0,k));
     tab1[i][6][j][2][2]=monTrim(str1.substr(k+2));
     break;
    }else if(textTest1=='>' || textTest1=='<'  ){
     tab1[i][6][j][2][0]=textTest1;
     tab1[i][6][j][2][1]=monTrim(str1.substr(0,k));
     tab1[i][6][j][2][2]=monTrim(str1.substr(k+1));
     break;
    }else{
     if(c1=='"'){
      dansChaineDouble=true;
     }else if(c1=='\''){
      dansChaineSimple=true;
     }else{
      variable1+=c1;
     }
    }   
   
   
   
   }
  }  
  niveauprecedent=tab1[i][0][0];
 }
 
 
 
 console.log('\n====ch=\n'+ch+'\n==== conditions ===========================\ntab1=',tab1);
 
 
 
 
 return {'status':true,'value':tab1}
 
}

//=====================================================================================================================
function boucleRecursiveSurCondition1(tab,ind1,niveau1,parentId){
 var t='';
 var dernierI=0;
 for(var i=ind1;i<tab.length;i++){
  if(tab[i][0][2]==parentId){
  
   if(tab[i][3]=='||'){
    t+='ou';
   }else if(tab[i][3]=='&&'){
    t+='et';
   }else{
    t+=tab[i][3];
   }
   
   if(tab[i][0][0]>niveau1){
    t+='('.repeat(tab[i][0][0]-niveau1);
   }
   if(tab[i][5]!==''){
//    t+=' untruc pour i='+i+' ';
    for(var j=0;j<tab[i][6].length;j++){
     var elt=tab[i][6][j];
     if(elt[0]=='||'){
      t+='ou(';
     }else if(elt[0]=='&&'){
      t+='et(';
     }else{
      t+='(';
     }

     if(elt[2][0]=='<'){
      t+='inf('+elt[2][1]+' , '+elt[2][2]+')';
     }else if(elt[2][0]=='<='){
      t+='infeg('+elt[2][1]+' , '+elt[2][2]+')';
     }else if(elt[2][0]=='>'){
      t+='sup('+elt[2][1]+' , '+elt[2][2]+')';
     }else if(elt[2][0]=='>='){
      t+='supegal('+elt[2][1]+' , '+elt[2][2]+')';
     }else if(elt[2][0]=='!=='){
      t+='diffstricte('+elt[2][1]+' , '+elt[2][2]+')';
     }else if(elt[2][0]=='==='){
      t+='egalstricte('+elt[2][1]+' , '+elt[2][2]+')';
     }else if(elt[2][0]=='!='){
      t+='diff('+elt[2][1]+' , '+elt[2][2]+')';
     }else if( elt[2][0] == '==' ){
      t+='egal('+elt[2][1]+' , '+elt[2][2]+')';
     }else{
      t+='TODO"'+elt[2][0]+'"('+elt[2][1]+' , '+elt[2][2]+')';
     }
     
     if(j!=tab[i][6].length-1){
//      t+=',';
     }
     t+=')';
    }
   }
/*
test=`  ( a == b )
  ||
  ( 
         tab[i][1]=="non" 
      || tab[i][1]=='ou' 
      || (
               premiereCondition==true 
            && tab[i][1]=='' 
         ) 
  ) 
  && tab[i][8]>0 
  && tab[i][2]=='f'
`  ;


(
  (egal(a , b))
)
ou(
    (egal(tab[i][1] , "non"))
  ou(egal(tab[i][1] , 'ou'))
  ou(
      (egal(premiereCondition , true))
    et(egal(tab[i][1] , ''))
  )
)
et(
  sup(tab[i][8] , 0)
)
et(
 egal(tab[i][2] , 'f')
)



*/   
   if(tab[i][4]=='||'){
    t+='ou';
   }else if(tab[i][4]=='&&'){
    t+='et';
   }else{
    t+=tab[i][4];
   }



   if(tab[i][0][3]>0){
    var obj=boucleRecursiveSurCondition1(tab,i+1,tab[i][0][0],tab[i][0][1]);
    if(obj.status==true){
     t+=obj.value;
    }else{
     return {'status':false,'message':'erreur recursif'};
    }
   }
   
   
   if(tab[i][0][0]>niveau1){
    t+=')'.repeat(tab[i][0][0]-niveau1);
   }

   
  }
 
 }
 return {'status':true,'value':t};
}

//=====================================================================================================================
function traiteConditionComplexe1(tab,ind,niveau,ch){
 var t='';
 var variable1='';
 var niveau=0;
 var c1='';
 var dansChaineDouble=false;
 var dansChaineSimple=false;
 var i=0;
 var j=0;
 var l01=ch.length;
 
 
 
 var obj1=decomposeConditionEnTableau1(tab,ind,niveau,ch);
 if(obj1.status===false){
  return {'status':false,'line':tab[ind][5]};
 }
 var tab1=obj1.value;

 var obj1=boucleRecursiveSurCondition1(tab1 , 1 , 0 , 0);
 console.log('apres recursif, obj1=',obj1);
 if(obj1.status===false){
  return {'status':false,'line':tab[ind][5]};
 }else{
  t=obj1.value;
 }
 
 
 
 
 
 
 return {'status':true,'value':t,'tropComplexe':true};
}
//=====================================================================================================================
function traiteCondition1(tab,ind,niveau,ch){
 var t='';
  
 // a priori, c'est une condition simple, dans la majorité des cas on a un " a < b " ou équivalent
 if( ch.indexOf('(')<0 && ch.indexOf(')')<0 && ch.indexOf('&&')<0  && ch.indexOf('||')<0 ){
  var tabCas=['<=','>=','<','>','!==','===','!=','=='];
  for(var i=0;i<=tabCas.length;i++){
   if(ch.indexOf(tabCas[i])>=0){
    var tt=ch.split(tabCas[i]);
    if(tt.length==2){
     var obj1=analyseChaineSimple1(tt[0],tab,ind,niveau);
     var obj2=analyseChaineSimple1(tt[1],tab,ind,niveau);
     if(obj1.status===true && obj2.status===true){
      if(obj1.isComplex || obj2.isComplex ){
       // cas complexe
      }else{
       if(tabCas[i]=='<'){
        t='inf('+obj1.value+' , '+obj2.value+')'
       }else if(tabCas[i]=='<='){
        t='infeg('+obj1.value+' , '+obj2.value+')'
       }else if(tabCas[i]=='>'){
        t='sup('+obj1.value+' , '+obj2.value+')'
       }else if(tabCas[i]=='>='){
        t='supeg('+obj1.value+' , '+obj2.value+')'
       }else if(tabCas[i]=='!=='){
        t='diffstricte('+obj1.value+' , '+obj2.value+')'
       }else if(tabCas[i]=='==='){
        t='egalstricte('+obj1.value+' , '+obj2.value+')'
       }else if(tabCas[i]=='!='){
        t='diff('+obj1.value+' , '+obj2.value+')'
       }else if(tabCas[i]=='=='){
        t='egal('+obj1.value+' , '+obj2.value+')'
       }
       return {status:true,value:t,'tropComplexe':false}
      }
     }
    }
   }
  }
 }

/* 
ch=`  (( a == b ))
  ||
  ( 
         tab[i][1]=="non" 
      || tab[i][1]=='ou' 
      || (
               premiereCondition==true 
            && tab[i][1]=='' 
         ) 
  ) 
  && tab[i][8]>0 
  && tab[i][2]=='f'
`  ;
*/

// test='  a==b && (c!=d)';


 console.log('ch='+ch);
 var obj1=traiteConditionComplexe1(tab,ind,niveau,ch);
 console.log('obj1.value='+obj1.value)
 
 
 if(obj1.status==true){
  t=obj1.value;
  return {'status':true,'value':t,'tropComplexe':false};
 }else{
  return {'status':true,'value':t,'tropComplexe':true};
 }
 
 
 
}
//=====================================================================================================================
function traiteBoucle1(tab,ind,niveau){
 var t='';
 var esp0=' '.repeat(NBESPACESREV*niveau);
 var esp1=' '.repeat(NBESPACESREV);
 
 t+='\n'+' '.repeat(niveau*NBESPACESREV)+'#('+JSON.stringify(tab[ind])+'';
 
 
 var s=tab[ind][4].substr(5);
 s=s.replace(/\{/g,'');
 
 
 
// console.log('traite boucle s='+s);


 for(var i=s.length-1;i>=0;i--){
  var c=s.substr(i,1);
  if(c==')'){
   s=s.substr(0,i);
   break;
  }else if(c!=' '){
   s=s.substr(0,i+1);
  }
 }
// console.log('traite boucle s='+s);

 var tab=s.split(';');
 if(tab.length!=3){
  return {'status':false,'message':'Erreur dans un for, il y a des point-virgules en trop','line':tab[ind][5]};
 }
 var initialisationAvecUneDeclaration=false;
 var initialisation=tab[0];
 initialisation=monTrim(initialisation);
// console.log('traite boucle initialisation="'+initialisation+'"');
 
 if(initialisation.substr(0 , 4)=='var '){
  var objinit=traiteDeclarationVariable1(tab,ind,niveau,initialisation);
  if(objinit.status==true && objinit.gauche.isComplex==false && objinit.droite.isNum==true){
   initialisationAvecUneDeclaration=true;
   console.log(objinit.value);
  }else{
   return {'status':false,'message':'Erreur dans un for, l\'initialisation ne fonctionne pas','line':tab[ind][5]};
  }
 }else{
  var objinit=traiteEgalite1(tab,ind,niveau,initialisation);
  if(objinit.status==true && objinit.gauche.isComplex==false && objinit.droite.isNum==true){
   console.log(objinit.value);
  }else{
   return {'status':false,'message':'Erreur dans un for, l\'initialisation ne fonctionne pas','line':tab[ind][5]};
  }

 }
 
 var valeurFinaleCondition='TODO ';
 var condition=tab[1];
 condition=monTrim(condition);
 var objCondition=traiteCondition1(tab,ind,niveau,condition);
 if(objCondition.status===true){
  if(objCondition.tropComplexe===false){
   valeurFinaleCondition=objCondition.value;
  }else{
   valeurFinaleCondition='TODO condition trop complexe ';
  }
 }else{
   return {'status':false,'message':'Erreur dans un for, la condition ne fonctionne pas','line':tab[ind][5]};
 }
 console.log('traite boucle condition="'+condition+'"');
 
 
 
 if(initialisationAvecUneDeclaration){
 t+='\n'+esp0+objinit.value+',';
 }
 t+='\n'+esp0+'boucle(';
 t+='\n'+esp0+esp1+'initialisation(affecte('+objinit.gauche.value+' , '+objinit.droite.value+')),';
 t+='\n'+esp0+esp1+'condition(('+valeurFinaleCondition+')),';
 t+='\n'+esp0+esp1+'increment(TODOaffecte(i , i+1)),';
 t+='\n'+esp0+esp1+'faire(';
 return {'status':true,'value':t,'fermetureNiveau':true,'ajouterNiveauDedans':2};
}
//=====================================================================================================================
function monTrim(s){
 var t='';
 for(var i=0;i<s.length;i++){
  var c=s.substr(i,1);
  if(c==' '){
   t=s.substr(i+1);
  }else{
   t=s.substr(i);
   break;
  }
 }
 s=t;
 for(var i=s.length-1;i>=0;i--){
  var c=s.substr(i,1);
  if(c==' '){
   t=s.substr(0,i);
  }else if(c!=' '){
   break;
  }
 }
 return t; 
}
//=====================================================================================================================
function traiteDeclarationFonction1(tab,ind,niveau){
 var t='';
 var esp0=' '.repeat(NBESPACESREV*niveau);
 var esp1=' '.repeat(NBESPACESREV);
 
 // function traiteCommentaire2(texte, niveau, ind) {
 var s=tab[ind][4].substr(9);
 var debutArguments=0;
 var nomFonction='';
 for(var i=0;i<s.length;i++){
  var c=s.substr(i,1);
  if(c=='('){
   debutArguments=i;
   break;
  }else{
   nomFonction+=c;
  }
 }
// console.log(s);
 var tabarg=[];
 s=s.substr(debutArguments);
 s=s.replace(/\(/g,'');
 s=s.replace(/\)/g,'');
 s=s.replace(/\{/g,'');
 tabarg=s.split(',');
 
 
 
 
 
// t+='\n'+esp0+'#('+JSON.stringify(tab[ind])+'';
 t+='\n'+esp0+'fonction(';
 t+='\n'+esp0+esp1+'definition(';
 t+='\n'+esp0+esp1+esp1+'nom('+nomFonction+'),';
 for(var i=0;i<tabarg.length;i++){
  if(i!=tabarg.length-1){
   t+='\n'+esp0+esp1+esp1+'argument('+tabarg[i].trim()+'),';
  }else{
   t+='\n'+esp0+esp1+esp1+'argument('+tabarg[i].trim()+')';
  }
 }
 t+='\n'+esp0+esp1+'),';
 t+='\n'+esp0+esp1+'contenu(';

 return {'status':true,'value':t,'fermetureNiveau':true,'ajouterNiveauDedans':2};
}
//=====================================================================================================================
function traiteIf1(tab,ind,niveau){
 var t='';
 var esp0=' '.repeat(NBESPACESREV*niveau);
 var esp1=' '.repeat(NBESPACESREV);
 
 t+='\n'+' '.repeat(niveau*NBESPACESREV)+'#('+JSON.stringify(tab[ind])+'';
 return {'status':true,'value':t,'fermetureNiveau':true,'ajouterNiveauDedans':1};
}
//=====================================================================================================================
function traiteLigne1(tab,ind,niveau){
 var t='';
 var fermetureNiveau=false;
 var ajouterNiveauDedans=0;
// t+=JSON.stringify(tab[ind])+'\n';
// console.log('traiteLigne tab['+ind+']=',tab[ind])
 var ligne=tab[ind][4];

 if(ligne.substr(0,4)=='var '){
 
  var obj=traiteDeclarationVariable1(tab,ind,niveau,'');
  if(obj.status===true){
   t+=obj.value;
  }else{
   temp={'status':false,'line':tab[ind][5],'message':'problème dans traite ligne pour une déclatation de variable'};
   return(logerreur(temp));
  }  

 }else if(ligne.substr(0,9)=='function '){
 
  var obj=traiteDeclarationFonction1(tab,ind,niveau);
  if(obj.status===true){
   t+=obj.value;
   fermetureNiveau=obj.fermetureNiveau;
   ajouterNiveauDedans=obj.ajouterNiveauDedans;
  }else{
   temp={'status':false,'line':tab[ind][5],'message':'problème dans traite ligne pour une déclatation de variable'};
   return(logerreur(temp));
  }  
 
 
 }else if(ligne.substr(0,5)=='for ('){
 
  var obj=traiteBoucle1(tab,ind,niveau);
  if(obj.status===true){
   t+=obj.value;
   fermetureNiveau=obj.fermetureNiveau;
   ajouterNiveauDedans=obj.ajouterNiveauDedans;
  }else{
   temp={'status':false,'line':tab[ind][5],'message':'problème dans traite ligne pour une boucle'};
   return(logerreur(temp));
  }  
 
 }else if(ligne.substr(0,4)=='if (' || ligne.substr(0,11)=='} else if (' || ligne.substr(0,8)=='} else {'){
 
  var obj=traiteIf1(tab,ind,niveau);
  if(obj.status===true){
   t+=obj.value;
   fermetureNiveau=obj.fermetureNiveau;
   ajouterNiveauDedans=obj.ajouterNiveauDedans;
  }else{
   temp={'status':false,'line':tab[ind][5],'message':'problème dans traite ligne pour une boucle'};
   return(logerreur(temp));
  }  
 
 
 }else{
 
   t+='\n'+' '.repeat(niveau*NBESPACESREV)+'#('+JSON.stringify(tab[ind])+')';
   temp={'status':false,'line':tab[ind][5],'message':'traiteLigne1 : cas non prévu : '+JSON.stringify(tab[ind])};
   console.log('',JSON.stringify(temp));
   logerreur(temp);
   
 }
 
 return {'status':true,'value':t,'fermetureNiveau':fermetureNiveau,'ajouterNiveauDedans':ajouterNiveauDedans};
}

//=====================================================================================================================
function traiteArbre1(tab,idDebut,idParent,niveau){
 var t='';
 var esp1=' '.repeat(NBESPACESREV);
 
 var fermetureNiveau=false;
 for(var i=idDebut;i<tab.length;i++){
  if(tab[i][2]==idParent){
   var obj=traiteLigne1(tab,i,niveau);
   if(obj.status===true){
    t+=obj.value;
//    fermetureNiveau=obj.fermetureNiveau;
    if(tab[i][3]>0){
     niveau=niveau+obj.ajouterNiveauDedans;
     var obj2=traiteArbre1(tab,i+1,tab[i][0],niveau);
     niveau=niveau-obj.ajouterNiveauDedans;
     if(obj2.status===true){
      t+=obj2.value;
      if(obj.fermetureNiveau){
       for( var j=obj.ajouterNiveauDedans-1;j>=0;j--){
        t+='\n'+' '.repeat(niveau*NBESPACESREV)+esp1.repeat(j)+')';
       }
      }
     }else{
      return({'status':false,'value':t,'message':'traite arbre erreur 0'});
     }
    }
   }else{
    return({'status':false,'value':t,'message':'traite arbre erreur 1'});
   }
  }else if(tab[i][2]<tab[idDebut][2]){
//   console.log('PAS a traiter, on break',tab[i]);
   break;
  }else{
//   console.log(niveau+'RAAAAH ',tab[i]);
  }
 }
 return({'status':true,'value':t,'fermetureNiveau':fermetureNiveau});
}


//=====================================================================================================================
function transform(){
  //"àà"

  console.log('\n=========================\ndébut de transforme')
  document.getElementById('resultat1').innerHTML='';
  clearMessages('zone_global_messages');
  var a=document.getElementById('txtar1');
  localStorage.setItem("fta_indexhtml_javascript_dernier_fichier_charge", a.value);
  
  
  
  var lines = a.value.split(/\r|\r\n|\n/);
  var count = lines.length;
  a.setAttribute('rows',count+1);
  
//  console.log('lines=',lines);
  var l01=lines.length;
  var mainParentId=0;
  //             0        1         2          3       4        5
  var newTab=[['mainId','niveau','mainParId','nbEnf','init','numLigneOriginale']];
//  var newTab=[['mainId','niveau','mainParId','nbEnf','init']];
  var mainId=0;
  for(var i=0;i<l01;i++){
   if(lines[i]!=''){
    var s=lines[i];
    var min=0;
    var niveau=0;
    for(var j=0;j<s.length;j++){
     if(s.substr(j,1)!==' '){
      niveau=j/2;
      s=s.substr(j);
      break;
     }
    }
    if(!( s=='}' || s=='' || s.substr(0,2) == '//' || s=="'use strict';")){
     newTab.push([mainId,niveau,mainParentId,0,s,i]);
     mainId++
    }
    
   }
  
  }
   
  console.log('newTab=',newTab);
  
    /*
      
      ==============================================================
      // mise à jour de l'id du parent[7] et du nombre d'éléments[8]
      ============================================================== 
    */
  l01=newTab.length;
  for(i=l01-1;i > 0;i=i-1){
      niveau=newTab[i][1];
      if(niveau==0){
       newTab[i][2]=-1;
      }else{
       for(j=i-1;j >= 0;j=j-1){
           if((newTab[j][1] == niveau-1)){
               newTab[i][2]=newTab[j][0]; // idParent
               newTab[j][3]=newTab[j][3]+1; // nombre d'enfants
               break;
           }
       }
      }
  }
  
  var obj=traiteArbre1(newTab,1,-1,0);  
  console.log('\n\n\n===================\n\n\nretour parsing js ='+obj.status+'\n=====================\n'+obj.value);
  displayMessages('zone_global_messages');
  document.getElementById('resultat1').innerHTML='<pre>'+obj.value.replace(/&/g,'&amp;').replace(/</g,'&lt;')+'</pre>';
  
  
  
 
}
//=====================================================================================================================
//=====================================================================================================================
//=====================================================================================================================
function chargerSourceDeTest(){
// debut de backtic ``` ci dessous pour la variable t = = = = = = = = = = = = = = = = = = = = = = = = = 
 var t=`//=========================================
'use strict';

for (var i = 0; i < a.b.c(d(),'e '," f ",5).f(g[h][i]) * (x>0&&!(!1==false)?4:5) ; i++) {
  document.getElementById("global_messages").innerHTML += 'hello';
}

var NBESPACESSOURCEPRODUIT = 4;
function traiteCommentaire2(texte, niveau, ind) {
  var s = "abc";
  var s = 'def';
  s = traiteCommentaireSourceEtGenere1(par1, par2.p, par3.p(a), b.c(par), false,'a');
  if (objMatSrc.value[i][1] == "#") {
  } else if (objMatSrc.value[i][1] == "src_javascript") {
    type_source = objMatSrc.value[i][1];
    break;
  } else if (objMatSrc.value[i][1] == "src_html") {
    type_source = objMatSrc.value[i][1];
    break;
  } else {
    return logerreur({status:false, id:i, message:"file core , problème"});
  }
  return s;
}
var glo=2;
//fin de test`;
// fin de backtic ``` ci dessus pour la variable t = = = = = = = = = = = = = = = = = = = = = = = = = 
 dogid('txtar1').value=t;
}
//=====================================================================================================================
function chargerLeDernierSource(){
 var fta_indexhtml_javascript_dernier_fichier_charge=localStorage.getItem("fta_indexhtml_javascript_dernier_fichier_charge");
// console.log('fta_indexhtml_javascript_dernier_fichier_charge=' , fta_indexhtml_javascript_dernier_fichier_charge );
 if(fta_indexhtml_javascript_dernier_fichier_charge!==null){
  dogid('txtar1').value=fta_indexhtml_javascript_dernier_fichier_charge;
 }
}

chargerLeDernierSource();
transform();
</script>
  
</body></html>